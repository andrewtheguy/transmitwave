<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Modem - Microphone Postamble Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .control-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .threshold-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #e0e0e0;
            flex: 1;
            min-width: 150px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .status.show {
            display: flex;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            color: #999;
            font-size: 0.85em;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #333;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .indicator.recording {
            background: #ff4444;
            animation: pulse 1s infinite;
        }

        .indicator.listening {
            background: #ffaa00;
            animation: pulse 1s infinite;
        }

        .indicator.detected {
            background: #44ff44;
        }

        .indicator.idle {
            background: #cccccc;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-box {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.95em;
            color: #555;
            line-height: 1.6;
        }

        .info-box strong {
            color: #333;
        }

        .visualization {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .buffer-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin: 10px 0;
        }

        .buffer-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .detection-list {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .detection-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .detection-time {
            color: #999;
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .control-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üé§ Microphone Postamble Detection</h1>
            <p class="subtitle">Real-time detection of audio modem postamble (end-of-frame marker) using your microphone</p>

            <div class="section">
                <h2>Controls</h2>

                <div class="control-group">
                    <div>
                        <label for="threshold">Detection Threshold</label>
                        <input type="range" id="threshold" min="0.1" max="0.9" step="0.05" value="0.4">
                        <div class="threshold-display" id="thresholdDisplay">0.40</div>
                    </div>
                    <div>
                        <label for="status">Status</label>
                        <div style="padding: 10px; background: #f0f0f0; border-radius: 6px; font-weight: bold;">
                            <span class="indicator idle" id="statusIndicator"></span>
                            <span id="statusText">Idle</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="startBtn">Start Listening</button>
                    <button class="btn-secondary" id="stopBtn" disabled>Stop Listening</button>
                    <button class="btn-secondary" id="clearBtn" disabled>Clear Detections</button>
                </div>

                <div class="status" id="status"></div>
            </div>

            <div class="section">
                <h2>Buffer Status</h2>
                <div class="visualization">
                    <div style="margin-bottom: 10px;">
                        <label>Audio Buffer</label>
                        <div class="buffer-bar">
                            <div class="buffer-fill" id="bufferFill" style="width: 0%;">
                                <span id="bufferPercent">0%</span>
                            </div>
                        </div>
                        <div style="text-align: left; font-size: 0.9em; color: #666;">
                            <div>Current: <strong id="bufferSize">0</strong> samples</div>
                            <div>Required: <strong id="requiredSize">0</strong> samples</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Detections</h2>
                <div class="detection-list" id="detectionList">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        No postambles detected yet
                    </div>
                </div>
            </div>

            <div class="info-box">
                <strong>‚ÑπÔ∏è How to use:</strong><br>
                1. Click "Start Listening" to begin microphone capture<br>
                2. Play encoded audio from your device or another speaker near the microphone<br>
                3. The detector will show <span class="indicator detected"></span> when it detects a postamble (end-of-frame)<br>
                4. Adjust the threshold to control sensitivity (lower = more sensitive)<br>
                5. View all detections in the list below
            </div>

            <div class="info-box" style="margin-top: 15px; background: #fff0f0; border-color: #ff6666;">
                <strong>üéµ Postamble Details:</strong><br>
                ‚Ä¢ Descending chirp from 4000Hz to 200Hz<br>
                ‚Ä¢ Duration: 250ms (4000 samples at 16kHz)<br>
                ‚Ä¢ Detection method: Cross-correlation with Pearson coefficient<br>
                ‚Ä¢ Purpose: Marks the end of the data frame<br>
                ‚Ä¢ Threshold range: 0.0 (always detect) to 1.0 (never detect)<br>
                ‚Ä¢ Recommended threshold: 0.4 for balanced detection
            </div>
        </div>
    </div>

    <script type="module">
        import init, { PostambleDetector } from './wasm/pkg/testaudio_wasm.js';

        let wasmReady = false;
        let detector = null;
        let audioContext = null;
        let analyser = null;
        let scriptProcessor = null;
        let isListening = false;
        let detectionCount = 0;

        // Initialize WASM
        init().then(() => {
            wasmReady = true;
            console.log('WASM initialized');

            // Get required size
            const requiredSize = PostambleDetector.required_size();
            document.getElementById('requiredSize').textContent = requiredSize.toLocaleString();
        }).catch(err => {
            console.error('Failed to initialize WASM:', err);
            showStatus('Error initializing WASM module', 'error');
        });

        // DOM Elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const thresholdInput = document.getElementById('threshold');
        const thresholdDisplay = document.getElementById('thresholdDisplay');
        const statusElement = document.getElementById('status');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const bufferFill = document.getElementById('bufferFill');
        const bufferSize = document.getElementById('bufferSize');
        const bufferPercent = document.getElementById('bufferPercent');
        const detectionList = document.getElementById('detectionList');

        // Update threshold display
        thresholdInput.addEventListener('change', () => {
            const value = parseFloat(thresholdInput.value);
            thresholdDisplay.textContent = value.toFixed(2);
            if (detector) {
                detector.set_threshold(value);
            }
        });

        // Update threshold on input (real-time)
        thresholdInput.addEventListener('input', () => {
            const value = parseFloat(thresholdInput.value);
            thresholdDisplay.textContent = value.toFixed(2);
        });

        // Start listening
        startBtn.addEventListener('click', async () => {
            if (!wasmReady) {
                showStatus('WASM module not ready', 'error');
                return;
            }

            try {
                // Create WASM detector
                const threshold = parseFloat(thresholdInput.value);
                detector = new PostambleDetector(threshold);

                // Get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);

                // Create analyser for visualization
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                // Create script processor for real-time processing
                scriptProcessor = audioContext.createScriptProcessor(1024, 1, 1);
                source.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                // Process audio data
                scriptProcessor.onaudioprocess = (event) => {
                    const inputData = event.inputData.getChannelData(0);
                    const samples = Array.from(inputData);

                    // Add samples to detector
                    const result = detector.add_samples(samples);

                    // Update buffer display
                    const current = detector.buffer_size();
                    const required = PostambleDetector.required_size();
                    const percent = Math.min(100, Math.round((current / required) * 100));

                    bufferSize.textContent = current.toLocaleString();
                    bufferFill.style.width = percent + '%';
                    bufferPercent.textContent = percent + '%';

                    // Check for detection
                    if (result >= 0) {
                        onPostambleDetected(result);
                    }
                };

                isListening = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                clearBtn.disabled = false;
                thresholdInput.disabled = true;

                statusIndicator.className = 'indicator listening';
                statusText.textContent = 'Listening';
                showStatus('Microphone listening... waiting for postamble', 'info');
            } catch (err) {
                console.error('Microphone error:', err);
                showStatus(`Microphone error: ${err.message}`, 'error');
                startBtn.disabled = false;
            }
        });

        // Stop listening
        stopBtn.addEventListener('click', () => {
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor.onaudioprocess = null;
            }
            if (analyser) {
                analyser.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }

            isListening = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            clearBtn.disabled = detectionCount === 0;
            thresholdInput.disabled = false;

            statusIndicator.className = 'indicator idle';
            statusText.textContent = 'Idle';
            showStatus('Microphone stopped', 'info');
        });

        // Clear detections
        clearBtn.addEventListener('click', () => {
            detectionCount = 0;
            detectionList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No postambles detected yet</div>';
            clearBtn.disabled = true;
        });

        // Postamble detected
        function onPostambleDetected(position) {
            detectionCount++;
            const time = new Date().toLocaleTimeString();

            // Add to detection list
            if (detectionCount === 1) {
                detectionList.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'detection-item';
            item.innerHTML = `
                <div><strong>Detection #${detectionCount}</strong></div>
                <div class="detection-time">${time}</div>
                <div>Position: ${position.toLocaleString()} samples</div>
            `;
            detectionList.insertBefore(item, detectionList.firstChild);

            // Show status
            showStatus(`‚úì Postamble detected at sample ${position}`, 'success');

            // Update indicator
            statusIndicator.className = 'indicator detected';
            statusText.textContent = 'Postamble Detected!';

            // Reset indicator after 500ms
            setTimeout(() => {
                if (isListening) {
                    statusIndicator.className = 'indicator listening';
                    statusText.textContent = 'Listening';
                }
            }, 500);

            clearBtn.disabled = false;
        }

        // Show status message
        function showStatus(message, type) {
            statusElement.textContent = message;
            statusElement.className = `status show ${type}`;

            if (type === 'error') {
                setTimeout(() => {
                    statusElement.classList.remove('show');
                }, 5000);
            }
        }
    </script>
</body>
</html>
